rule_id: AK-007
name: credential_tool_from_non_credential_agent
description: >
  Detects when an agent not authorized for credential access invokes
  a credential-category tool. May indicate stolen credentials or
  scope exploitation.
severity: critical
category: capability_escalation
layer: 1
phase: 0
requires_baseline: false
safe_mode_compatible: true

match:
  conditions:
    - field: agent_type
      not_in: ["credential_manager", "secret_rotator", "auth_service", "vault_agent"]
    - field: actions[*].tool_category
      contains_any: ["credential"]
  logic: ALL

response:
  alert: true
  recommended_action: >
    Investigate why this agent is accessing credentials. Review recent
    inputs for prompt injection. Check if agent configuration changed.

tags:
  - capability_escalation
  - credential_abuse
