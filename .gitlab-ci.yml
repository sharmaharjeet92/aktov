stages:
  - lint
  - test
  - build

variables:
  UV_CACHE_DIR: .uv-cache
  PIP_CACHE_DIR: .pip-cache

cache:
  key: uv-${CI_COMMIT_REF_SLUG}
  paths:
    - .uv-cache/
    - .venv/

.uv-setup: &uv-setup
  image: python:3.12-slim
  before_script:
    - pip install uv
    - uv sync --all-packages

lint:
  <<: *uv-setup
  stage: lint
  script:
    - uv run ruff check .
    - uv run ruff format --check .

test-sdk:
  <<: *uv-setup
  stage: test
  script:
    - uv run pytest sdk/tests -v --tb=short
  artifacts:
    reports:
      junit: sdk/tests/report.xml
    when: always

test-cloud:
  <<: *uv-setup
  stage: test
  services:
    - name: postgres:16-alpine
      alias: postgres
      variables:
        POSTGRES_DB: chainwatch_test
        POSTGRES_USER: chainwatch
        POSTGRES_PASSWORD: test
  variables:
    DATABASE_URL: "postgresql+asyncpg://chainwatch:test@postgres:5432/chainwatch_test"
    CW_ENVIRONMENT: test
  script:
    - uv run pytest cloud/tests -v --tb=short
  artifacts:
    reports:
      junit: cloud/tests/report.xml
    when: always

build-sdk:
  <<: *uv-setup
  stage: build
  script:
    - cd sdk && uv build
  artifacts:
    paths:
      - sdk/dist/
  only:
    - tags
    - main
